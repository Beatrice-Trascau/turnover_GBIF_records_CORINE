---
title: "All to Urban JDI Data Exploration"
format: html
editor: visual
number-sections: true
crossref:
  fig-title: "Figure"
  tbl-title: "Table"
---

# Aims

This document outlines data exploration steps of the data used to model temporal turnover in land cover cells undergoing the All to Urban/Artificial Surfaces transition.

```{r libraries}
#| label: packages
#| echo: false
#| include: false
library(here)
source(here("scripts", "0_setup.R"))
```

# All GBIF Occurences

```{r data preparation}
#| label: data-prep
#| include: false

# Load Turnover data
load(here("data", "derived_data", 
          "all_periods_turnover_all_land_cover_climate_15km.rda"))

# Prepare data
turnover_all_urban_15km <- all_periods_turnover_with_climate |>
  select(-c('2000-2006_Forest no change', '2000-2006_Forest to TWS',
            '2000-2006_TWS no change', '2000-2006_TWS to Forest',
            '2006-2012_Forest no change', '2006-2012_Forest to TWS',
            '2006-2012_TWS no change', '2006-2012_TWS to Forest',
            '2012-2018_Forest no change', '2012-2018_Forest to TWS',
            '2012-2018_TWS no change', '2012-2018_TWS to Forest')) |>
  # determine which rows belong to which time period
  mutate(urban_no_change = case_when(lc_time_period == "2000-2006" ~ `2000-2006_Urban_no_change`,
                                   lc_time_period == "2006-2012" ~ `2006-2012_Urban_no_change`,
                                   lc_time_period == "2012-2018" ~ `2012-2018_Urban_no_change`,
                                   TRUE ~ NA_real_),
         all_to_urban = case_when(lc_time_period == "2000-2006" ~ `2000-2006_all_to_urban`,
                                   lc_time_period == "2006-2012" ~ `2006-2012_all_to_urban`,
                                   lc_time_period == "2012-2018" ~ `2012-2018_all_to_urban`,
                                   TRUE ~ NA_real_)) |>
  # remove columns no longer required
  select(-`2000-2006_Urban_no_change`, -`2000-2006_all_to_urban`, 
         -`2006-2012_Urban_no_change`,-`2006-2012_all_to_urban`, 
         -`2012-2018_Urban_no_change`, -`2012-2018_all_to_urban`)

# Get N
N <- nrow(turnover_all_urban_15km)

# Calculate new JDI values
turnover_all_urban_15km <- turnover_all_urban_15km |>
  mutate(JDI_beta = (JDI_manual * (N - 1) + 0.5) / N)

# Prepare data for GLS: remove rows with missing x or y and categorise time periods
turnover_all_urban_15km_coords_time <- turnover_all_urban_15km |>
  filter(!is.na(x) & !is.na(y)) |>
  mutate(time_numeric = case_when(lc_time_period == "2000-2006" ~ 1,
                                  lc_time_period == "2006-2012" ~ 2,
                                  lc_time_period == "2012-2018" ~ 3))
# Log transform recorder effort values
turnover_all_urban_15km_coords_time <- turnover_all_urban_15km_coords_time |>
  mutate(log_recorder_effort = log(recorder_effort))
```

# Summary Statistics

```{r summary stats}
#| label: summary-stats
#| echo: false

# Extract summary data
summary_by_period <- turnover_all_urban_15km  |>
  group_by(lc_time_period) |>
  summarize(n_observations = n(),
            mean_JDI = mean(JDI_manual, na.rm = TRUE),
            sd_JDI = sd(JDI_manual, na.rm = TRUE),
            mean_all_to_urban = mean(all_to_urban, na.rm = TRUE),
            sd_all_to_urban = sd(all_to_urban, na.rm = TRUE),
            mean_urban_no_change = mean(urban_no_change, na.rm = TRUE),
            sd_urban_no_change = sd(urban_no_change, na.rm = TRUE),
            mean_delta_recorder_effort = mean(delta_recorder_effort, na.rm = TRUE),
            mean_recorder_effort = mean(recorder_effort, na.rm = TRUE))

# Create table for period summary
summary_period_table <- summary_by_period |>
  kbl(caption = "Table 1: Summary Statistics by Time Period",
      digits = 3,
      align = c("l", rep("r", ncol(summary_by_period)-1))) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = TRUE) |>
  column_spec(1, bold = TRUE) |>
  row_spec(0, bold = TRUE, background = "#E6F0FF") |>
  add_header_above(c(" " = 1, 
                     "Sample" = 1,
                     "Turnover" = 2, 
                     "All to Urban" = 2,
                     "Urban No Change" = 2,
                     "Recorder Effort" = 2))

# Print the table
summary_period_table
```

Firstly, we look at the distribution of values across each of the response variables used in our model.

```{r variables}
#| label: variables-distributions
#| echo: false

# Jaccard's Dissimilarity Index
jdi_hist <- ggplot(turnover_all_urban_15km, aes(x = JDI_manual)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Jaccard Dissimilarity Index",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# All -> Urban
all_to_urban_hist <- ggplot(turnover_all_urban_15km, aes(x = all_to_urban)) +
  geom_histogram(bins = 30, fill = "darkgreen", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "All to Urban Transition (pixel count)",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Urban No Change
urban_no_change_hist <- ggplot(turnover_all_urban_15km, aes(x = urban_no_change)) +
  geom_histogram(bins = 30, fill = "brown", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Urban No Change (pixel count)",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Recorder effort
recorder_effort_plot <- ggplot(turnover_all_urban_15km, aes(x = recorder_effort)) +
  geom_histogram(bins = 30, fill = "orange", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Recorder Effort",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Delta recorder effort
delta_recorder_effort_plot <- ggplot(turnover_all_urban_15km, aes(x = delta_recorder_effort)) +
  geom_histogram(bins = 30, fill = "coral", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Delta Recorder Effort",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Combine plots
urban_plots <- plot_grid(jdi_hist, all_to_urban_hist, urban_no_change_hist, recorder_effort_plot, delta_recorder_effort_plot, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)"))

# Print plots
urban_plots
```

## Correlation Matrix

Then, we will also check the correlation between the variables used in the analysis.

```{r variable relationship}
#| label: variables-relationships
#| echo: false

# Correlation matrix for numeric variables
numeric_vars <- turnover_all_urban_15km_coords_time  |>
  select(beta_jtu, beta_jne, beta_jac, all_to_urban, urban_no_change, 
         recorder_effort, delta_recorder_effort,
         log_recorder_effort, temp_change, precip_change, total_spp_before,
         total_spp_after, total_occ_before, total_occ_after)

# Calculate correlation matrix
cor_matrix <- cor(numeric_vars, use = "pairwise.complete.obs")

# Create correlation plot
cor_plot <- corrplot(cor_matrix, 
                     method = "circle", 
                     type = "upper", 
                     tl.col = "black", 
                     tl.srt = 45, 
                     addCoef.col = "black", 
                     number.cex = 0.7,
                     diag = FALSE)
```

Fortunately, we see no concerningly large correlations between variables used in the analysis.

## Relationships

```{r variable relationships}
#| label: fig-variables-relationships
#| echo: false
#| fig-cap: "Relationships between beta_jtu and variables used in the models"
#| fig-width: 6
#| fig-height: 4


# Define color
point_color <- "#2196F3"

## Plot 1: beta_jtu vs all_to_urban ----------------------------------------

plot1 <- ggplot(turnover_all_urban_15km_coords_time, 
                aes(x = all_to_urban, y = beta_jtu)) +
  geom_point(alpha = 0.3, color = point_color, size = 0.8) +
  geom_smooth(color = "red", se = TRUE, linewidth = 1) +
  labs(x = "Forest → TWS (pixels)", y = "beta_jtu", title = "a)") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9, color = "black"),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 0.5),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.3)
  )

## Plot 2: beta_jtu vs urban_no_change --------------------------------------

plot2 <- ggplot(turnover_all_urban_15km_coords_time, 
                aes(x = urban_no_change, y = beta_jtu)) +
  geom_point(alpha = 0.3, color = point_color, size = 0.8) +
  geom_smooth(color = "red", se = TRUE, linewidth = 1) +
  labs(x = "Forest no change (pixels)", y = NULL, title = "b)") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9, color = "black"),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 0.5),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.3)
  )

## Plot 3: beta_jtu vs log_recorder_effort -----------------------------------

plot3 <- ggplot(turnover_all_urban_15km_coords_time, 
                aes(x = log_recorder_effort, y = beta_jtu)) +
  geom_point(alpha = 0.3, color = point_color, size = 0.8) +
  geom_smooth(color = "red", se = TRUE, linewidth = 1) +
  labs(x = "log(Recorder effort)", y = NULL, title = "c)") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9, color = "black"),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 0.5),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.3)
  )

## Plot 4: beta_jtu vs delta_recorder_effort ---------------------------------

plot4 <- ggplot(turnover_all_urban_15km_coords_time, 
                aes(x = delta_recorder_effort, y = beta_jtu)) +
  geom_point(alpha = 0.3, color = point_color, size = 0.8) +
  geom_smooth(color = "red", se = TRUE, linewidth = 1) +
  labs(x = "ΔRecorder effort", y = "beta_jtu", title = "d)") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9, color = "black"),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 0.5),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.3)
  )

## Plot 5: beta_jtu vs temp_change -------------------------------------------

plot5 <- ggplot(turnover_all_urban_15km_coords_time, 
                aes(x = temp_change, y = beta_jtu)) +
  geom_point(alpha = 0.3, color = point_color, size = 0.8) +
  geom_smooth(color = "red", se = TRUE, linewidth = 1) +
  labs(x = "Temperature change (°C)", y = NULL, title = "e)") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9, color = "black"),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 0.5),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.3)
  )

## Plot 6: beta_jtu vs precip_change -----------------------------------------

plot6 <- ggplot(turnover_all_urban_15km_coords_time, 
                aes(x = precip_change, y = beta_jtu)) +
  geom_point(alpha = 0.3, color = point_color, size = 0.8) +
  geom_smooth(color = "red", se = TRUE, linewidth = 1) +
  labs(x = "Precipitation change (mm/yr)", y = NULL, title = "f)") +
  theme_classic() +
  theme(
    plot.title = element_text(size = 11, face = "bold", hjust = 0),
    axis.title = element_text(size = 10),
    axis.text = element_text(size = 9, color = "black"),
    panel.border = element_rect(fill = NA, color = "black", linewidth = 0.5),
    panel.grid.major = element_line(color = "grey90", linewidth = 0.3)
  )

## Combine all plots ---------------------------------------------------------

combined_raw_plot <- (plot1 | plot2 | plot3) / (plot4 | plot5 | plot6)

# Display
print(combined_raw_plot)

```

# Modeling

## (Final) Trial 2: GLS with log recorder effort

```{r gls log model diagnostic}
#| label: fig-gls-logged-values
#| echo: false
#| message: false
#| fig-width: 12
#| fig-height: 8
#| fig-cap: "Diagnostic plots for GLS model 2"

# Load model
load(here("data", "models", "final", "AllUrban_turnover_model1_gls.RData"))

# Extract residuals
residuals_gls <- residuals(AllUrban_turnover_model1_gls, type = "normalized")

# Get the model frame to ensure we're using the exact same data
model_data <- getData(AllUrban_turnover_model1_gls)

# Basic residual plots
par(mfrow = c(2, 2))

# Residuals vs fitted
plot(fitted(AllUrban_turnover_model1_gls), residuals_gls,
     xlab = "Fitted Values", ylab = "Normalized Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)

# QQ plot
qqnorm(residuals_gls, main = "Normal Q-Q Plot")
qqline(residuals_gls, col = "red")

# Residuals vs predictors
plot(model_data$all_to_urban, residuals_gls,
     xlab = "All to Urban", ylab = "Normalized Residuals",
     main = "Residuals vs All to Urban")
abline(h = 0, col = "red", lty = 2)

plot(model_data$log_recorder_effort, residuals_gls,
     xlab = "Recorder Effort", ylab = "Normalized Residuals",
     main = "Residuals vs Recorder Effort")
abline(h = 0, col = "red", lty = 2)
```

The diagnostic plots for this model show that:

1.  Residuals vs Fitted:
    -   Most residuals are centered around 0
    -   Spread is roughly constant across the fitted values
2.  QQ Plot:
    -   There is some deviation from the red line, especially at the bottom of the tail, suggesting that residuals are not perfectly normal
    -   Our sample size is relatively large, and this is somewhat common with ecological data
3.  Residuals vs. Forest -\> TWS
    -   Data concentration at 0, which makes sense given that most of the cells will have no TWS to Forest
    -   But relatively even spread
4.  Residuals vs. Recorder Effort
    -   Residuals are evenly spread across the range of log recorder effort
    -   Residuals are (mostly) centered around zero and there is no obvious pattern observed

This model looks ok to use! Therefore, it will be the one used in the manuscript.

### Trial 2: GLS with interaction

```{r gls interaction correlation}
#| label: fig-gls-interaction-values
#| echo: false
#| message: false
#| fig-width: 12
#| fig-height: 8
#| fig-cap: "Diagnostic plots for GLS model 2"

# Load model
load(here("data", "models", "exploratory", "AllUrban_turnover_model2_gls_interaction.RData"))

# Extract residuals
residuals_gls <- residuals(AllUrban_turnover_model2_gls_interaction, type = "normalized")

# Get the model frame to ensure we're using the exact same data
model_data <- getData(AllUrban_turnover_model2_gls_interaction)

# Basic residual plots
par(mfrow = c(2, 2))

# Residuals vs fitted
plot(fitted(AllUrban_turnover_model2_gls_interaction), residuals_gls,
     xlab = "Fitted Values", ylab = "Normalized Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)

# QQ plot
qqnorm(residuals_gls, main = "Normal Q-Q Plot")
qqline(residuals_gls, col = "red")

# Residuals vs predictors
plot(model_data$all_to_urban, residuals_gls,
     xlab = "All to Urban", ylab = "Normalized Residuals",
     main = "Residuals vs All to Urban")
abline(h = 0, col = "red", lty = 2)

plot(model_data$log_recorder_effort, residuals_gls,
     xlab = "Recorder Effort", ylab = "Normalized Residuals",
     main = "Residuals vs Recorder Effort")
abline(h = 0, col = "red", lty = 2)

```

# Vascular Plant Occurences

```{r prepare vascular plant data}
#| label: plant-data-prep
#| include: false

# Load Turnover data
load(here("data", "derived_data", 
          "vascular_plants_turnover_all_land_cover_climate_15km.rda"))

# Select only All -> Urban columns
  # check column names
colnames(vascular_plants_turnover_with_climate)

# Also rename the columns for easier manipulation of df
plants_turnover_all_urban_15km <- vascular_plants_turnover_with_climate |>
  select(-c('2000-2006_Forest no change', '2000-2006_Forest to TWS',
            '2000-2006_TWS no change', '2000-2006_TWS to Forest',
            '2006-2012_Forest no change', '2006-2012_Forest to TWS',
            '2006-2012_TWS no change', '2006-2012_TWS to Forest',
            '2012-2018_Forest no change', '2012-2018_Forest to TWS',
            '2012-2018_TWS no change', '2012-2018_TWS to Forest')) |>
  # determine which rows belong to which time period
  mutate(urban_no_change = case_when(lc_time_period == "2000-2006" ~ `2000-2006_Urban_no_change`,
                                     lc_time_period == "2006-2012" ~ `2006-2012_Urban_no_change`,
                                     lc_time_period == "2012-2018" ~ `2012-2018_Urban_no_change`,
                                     TRUE ~ NA_real_),
         all_to_urban = case_when(lc_time_period == "2000-2006" ~ `2000-2006_all_to_urban`,
                                  lc_time_period == "2006-2012" ~ `2006-2012_all_to_urban`,
                                  lc_time_period == "2012-2018" ~ `2012-2018_all_to_urban`,
                                  TRUE ~ NA_real_)) |>
  # remove columns no longer required
  select(-`2000-2006_Urban_no_change`, -`2006-2012_Urban_no_change`, 
         -`2012-2018_Urban_no_change`,-`2000-2006_all_to_urban`, 
         -`2006-2012_all_to_urban`, -`2012-2018_all_to_urban`)

# Remove rows that might have NA for x or y and categorise time periods for GLS
plants_turnover_all_urban_15km_coords_time <- plants_turnover_all_urban_15km |>
  filter(!is.na(x) & !is.na(y)) |>
  mutate(time_numeric = case_when(lc_time_period == "2000-2006" ~ 1,
                                  lc_time_period == "2006-2012" ~ 2,
                                  lc_time_period == "2012-2018" ~ 3),
         log_recorder_effort = log(recorder_effort))

```

## Summary Statistics

```{r plant-summary-stats}
#| label: tbl-summary-stats-plants
#| echo: false
#| tbl-cap: "Summary Statistics of Jaccard Dissimilarity Index (JDI) by Time Period for Vascular Plant Records"

# Extract summary data
plant_summary_by_period <- plants_turnover_all_urban_15km_coords_time |>
  group_by(lc_time_period) |>
  summarize(n_observations = n(),
            mean_JDI = mean(JDI_manual, na.rm = TRUE),
            sd_JDI = sd(JDI_manual, na.rm = TRUE),
            mean_all_to_urban = mean(all_to_urban, na.rm = TRUE),
            sd_all_to_urban = sd(all_to_urban, na.rm = TRUE),
            mean_urban_no_change = mean(urban_no_change, na.rm = TRUE),
            sd_urban_no_change = sd(urban_no_change, na.rm = TRUE),
            mean_delta_recorder_effort = mean(delta_recorder_effort, na.rm = TRUE),
            mean_recorder_effort = mean(recorder_effort, na.rm = TRUE))

# Create table for period summary
plant_summary_by_period <- plant_summary_by_period |>
  kbl(digits = 3,
      align = c("l", rep("r", ncol(plant_summary_by_period)-1))) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = TRUE) |>
  column_spec(1, bold = TRUE) |>
  row_spec(0, bold = TRUE, background = "#E6F0FF") |>
  add_header_above(c(" " = 1, 
                     "Sample" = 1,
                     "Turnover" = 2, 
                     "All to Urban" = 2,
                     "Urban No Change" = 2,
                     "Recorder Effort" = 2))

# Print the table
plant_summary_by_period
```

## Distribution of Values

```{r plant-variables}
#| label: fig-variables-distributions-plant
#| fig-cap: "Distribution of a) Jaccard Dissimilarity Index, b) TWS to Forest transition pixel count, c) TWS No Change pixel count, d) Recorder Effort e) Change in Recorder Effort in Subser with Only Vascular Plant Records"
#| echo: false


# Jaccard's Dissimilarity Index
plant_jdi_hist <- ggplot(plants_turnover_all_urban_15km_coords_time, aes(x = JDI_manual)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Jaccard Dissimilarity Index",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# All -> Urban
plant_all_to_urban_hist <- ggplot(plants_turnover_all_urban_15km_coords_time, aes(x = all_to_urban)) +
  geom_histogram(bins = 30, fill = "darkgreen", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "All to Urban Transition (pixel count)",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Urban No Change
plant_urban_no_change_hist <- ggplot(plants_turnover_all_urban_15km_coords_time, aes(x = urban_no_change)) +
  geom_histogram(bins = 30, fill = "brown", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Urban No Change (pixel count)",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Recorder effort
plant_recorder_effort_plot <- ggplot(plants_turnover_all_urban_15km_coords_time, aes(x = recorder_effort)) +
  geom_histogram(bins = 30, fill = "orange", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Recorder Effort",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Delta recorder effort
plant_delta_recorder_effort_plot <- ggplot(plants_turnover_all_urban_15km_coords_time, aes(x = delta_recorder_effort)) +
  geom_histogram(bins = 30, fill = "coral", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Delta Recorder Effort",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Combine plots
plant_urban_plots <- plot_grid(plant_jdi_hist, plant_all_to_urban_hist, plant_urban_no_change_hist, plant_recorder_effort_plot, plant_delta_recorder_effort_plot, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)"))

# Print plots
plant_urban_plots
```

## Modeling

### (Final)Trial1: GLS with logged recorder effort

```{r gls plants log correlation}
#| label: gls-logged-corr-structure
#| echo: false
#| message: false

# Load model
load(here("data", "models", "final", "plants_AllUrban_model1_gls.RData"))

# Extract correlation structure parameters
print(plants_AllUrban_model1_gls$modelStruct$corStruct)

# Get range parameter
range_param <- coef(plants_AllUrban_model1_gls$modelStruct$corStruct, unconstrained = FALSE)
```

```{r gls plants log model diagnostic}
#| label: fig-gls-logged-values
#| echo: false
#| message: false
#| fig-width: 12
#| fig-height: 8
#| fig-cap: "Diagnostic plots for GLS model 2"

# Extract residuals
residuals_gls <- residuals(plants_AllUrban_model1_gls, type = "normalized")

# Get the model frame to ensure we're using the exact same data
model_data <- getData(plants_AllUrban_model1_gls)

# Basic residual plots
par(mfrow = c(2, 2))

# Residuals vs fitted
plot(fitted(plants_AllUrban_model1_gls), residuals_gls,
     xlab = "Fitted Values", ylab = "Normalized Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)

# QQ plot
qqnorm(residuals_gls, main = "Normal Q-Q Plot")
qqline(residuals_gls, col = "red")

# Residuals vs predictors
plot(model_data$all_to_urban, residuals_gls,
     xlab = "All to Urban", ylab = "Normalized Residuals",
     main = "Residuals vs TWS to Forest")
abline(h = 0, col = "red", lty = 2)

plot(model_data$log_recorder_effort, residuals_gls,
     xlab = "Recorder Effort", ylab = "Normalized Residuals",
     main = "Residuals vs Recorder Effort")
abline(h = 0, col = "red", lty = 2)
```

The diagnostic plots for this model show that:

1.  Residuals vs Fitted:
    -   There is some funneling, with variance spreading out at both ends
    -   This plots suggests residuals are suffering from a bit of heteroscedasticity
2.  QQ Plot:
    -   There is deviation from the line at both ends
    -   Our sample size is relatively large, and this is somewhat common with ecological data
3.  Residuals vs. Forest -\> TWS
    -   Data concentration at 0, which makes sense given that most of the cells will have no TWS to Forest
    -   There is a bit of fanning
4.  Residuals vs. Recorder Effort
    -   Residuals are evenly spread across the range of log recorder effort
    -   Residuals are (mostly) centered around zero and there is no obvious pattern observed

This model looks borderline acceptable to use. I could probably justify using it by wanting to keep the consistency.

### Trail 2: Plant GLS with interaction

```{r plant gls interaction correlation}
#| label: gls-plant-logged-corr-structure
#| echo: false
#| message: false

# Load model
load(here("data", "models", "exploratory",
                 "plants_AllUrban_model2_gls_interaction.RData"))

# Extract residuals
residuals_gls <- residuals(plants_AllUrban_model2_gls_interaction, type = "normalized")

# Get the model frame to ensure we're using the exact same data
model_data <- getData(plants_AllUrban_model2_gls_interaction)

# Basic residual plots
par(mfrow = c(2, 2))

# Residuals vs fitted
plot(fitted(plants_AllUrban_model2_gls_interaction), residuals_gls,
     xlab = "Fitted Values", ylab = "Normalized Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)

# QQ plot
qqnorm(residuals_gls, main = "Normal Q-Q Plot")
qqline(residuals_gls, col = "red")

# Residuals vs predictors
plot(model_data$all_to_urban, residuals_gls,
     xlab = "All to Urban", ylab = "Normalized Residuals",
     main = "Residuals vs TWS to Forest")
abline(h = 0, col = "red", lty = 2)

plot(model_data$log_recorder_effort, residuals_gls,
     xlab = "Recorder Effort", ylab = "Normalized Residuals",
     main = "Residuals vs Recorder Effort")
abline(h = 0, col = "red", lty = 2)
```

# Bird Occurrences

```{r prepare bird data}
#| label: bird-data-prep
#| include: false

# Turnover data for birds
load(here("data", "derived_data", 
          "bird_turnover_all_land_cover_climate_15km.rda"))

birds_turnover_all_urban_15km <- birds_turnover_with_climate |>
  select(-c('2000-2006_Forest no change', '2000-2006_Forest to TWS',
            '2000-2006_TWS no change', '2000-2006_TWS to Forest',
            '2006-2012_Forest no change', '2006-2012_Forest to TWS',
            '2006-2012_TWS no change', '2006-2012_TWS to Forest',
            '2012-2018_Forest no change', '2012-2018_Forest to TWS',
            '2012-2018_TWS no change', '2012-2018_TWS to Forest')) |>
  # determine which rows belong to which time period
  mutate(urban_no_change = case_when(lc_time_period == "2000-2006" ~ `2000-2006_Urban_no_change`,
                                     lc_time_period == "2006-2012" ~ `2006-2012_Urban_no_change`,
                                     lc_time_period == "2012-2018" ~ `2012-2018_Urban_no_change`,
                                     TRUE ~ NA_real_),
         all_to_urban = case_when(lc_time_period == "2000-2006" ~ `2000-2006_all_to_urban`,
                                  lc_time_period == "2006-2012" ~ `2006-2012_all_to_urban`,
                                  lc_time_period == "2012-2018" ~ `2012-2018_all_to_urban`,
                                  TRUE ~ NA_real_)) |>
  # remove columns no longer required
  select(-`2000-2006_Urban_no_change`, -`2006-2012_Urban_no_change`, 
         -`2012-2018_Urban_no_change`,-`2000-2006_all_to_urban`, 
         -`2006-2012_all_to_urban`, -`2012-2018_all_to_urban`)

# Check transformation went ok
head(birds_turnover_all_urban_15km)

# Remove rows that might have NA for x or y & categorise time periods
birds_turnover_all_urban_15km_coords_time <- birds_turnover_all_urban_15km |>
  filter(!is.na(x) & !is.na(y)) |>
  mutate(time_numeric = case_when(lc_time_period == "2000-2006" ~ 1,
                                  lc_time_period == "2006-2012" ~ 2,
                                  lc_time_period == "2012-2018" ~ 3),
         log_recorder_effort = log(recorder_effort))
```

## Summary Statistics

```{r bird summary statistics}
#| label: tbl-summary-stats-birds
#| echo: false
#| tbl-cap: "Summary Statistics of Jaccard Dissimilarity Index (JDI) by Time Period for Bird Records"

# Extract summary data
birds_summary_by_period <- birds_turnover_all_urban_15km_coords_time |>
  group_by(lc_time_period) |>
  summarize(n_observations = n(),
            mean_JDI = mean(JDI_manual, na.rm = TRUE),
            sd_JDI = sd(JDI_manual, na.rm = TRUE),
            mean_all_to_urban = mean(all_to_urban, na.rm = TRUE),
            sd_all_to_urban = sd(all_to_urban, na.rm = TRUE),
            mean_urban_no_change = mean(urban_no_change, na.rm = TRUE),
            sd_urban_no_change = sd(urban_no_change, na.rm = TRUE),
            mean_delta_recorder_effort = mean(delta_recorder_effort, na.rm = TRUE),
            mean_recorder_effort = mean(recorder_effort, na.rm = TRUE))

# Create table for period summary
birds_summary_by_period <- birds_summary_by_period |>
  kbl(digits = 3,
      align = c("l", rep("r", ncol(birds_summary_by_period)-1))) |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"),
                full_width = TRUE) |>
  column_spec(1, bold = TRUE) |>
  row_spec(0, bold = TRUE, background = "#E6F0FF") |>
  add_header_above(c(" " = 1, 
                     "Sample" = 1,
                     "Turnover" = 2, 
                     "TWS to Forst" = 2,
                     "TWS No Change" = 2,
                     "Recorder Effort" = 2))

# Print the table
birds_summary_by_period
```

## Distribution of Values

```{r bird values}
#| label: fig-variables-distributions-birds
#| fig-cap: "Distribution of a) Jaccard Dissimilarity Index, b) Forest to TWS transition pixel count, c) Forest No Change pixel count, d) Recorder Effort e) Change in Recorder Effort in Subser with Only Bird Records"
#| echo: false

# Jaccard's Dissimilarity Index
bird_jdi_hist <- ggplot(birds_turnover_all_urban_15km_coords_time, aes(x = JDI_manual)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Jaccard Dissimilarity Index",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# TWS -> Forest
bird_tws_to_forest_hist <- ggplot(birds_turnover_all_urban_15km_coords_time, aes(x = all_to_urban)) +
  geom_histogram(bins = 30, fill = "brown", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "All to Urban Transition (pixel count)",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# TWS No Change
bird_tws_no_change_hist <- ggplot(birds_turnover_all_urban_15km_coords_time, aes(x = urban_no_change)) +
  geom_histogram(bins = 30, fill = "darkgreen", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Urban No Change (pixel count)",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Recorder effort
bird_recorder_effort_plot <- ggplot(birds_turnover_all_urban_15km_coords_time, aes(x = recorder_effort)) +
  geom_histogram(bins = 30, fill = "orange", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Recorder Effort",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Delta recorder effort
bird_delta_recorder_effort_plot <- ggplot(birds_turnover_all_urban_15km_coords_time, aes(x = delta_recorder_effort)) +
  geom_histogram(bins = 30, fill = "coral", color = "white", alpha = 0.7) +
  facet_wrap(~ lc_time_period) +
  labs(x = "Delta Recorder Effort",
       y = "Count") +
  theme_classic() +
  theme(strip.background = element_rect(fill = "lightgrey"),
        strip.text = element_text(face = "bold"))

# Combine plots
bird_plots <- plot_grid(bird_jdi_hist, bird_tws_to_forest_hist, bird_tws_no_change_hist, bird_recorder_effort_plot, bird_delta_recorder_effort_plot, ncol = 2, labels = c("a)", "b)", "c)", "d)", "e)"))

# Print plots
bird_plots
```

## Modeling

### (Final) Trial 1: GLS with log recording effort

```{r bird gls}
#| label: bird-gls-output
#| echo: false
#| message: false

# Load model
load(here("data", "models", "final", "birds_AllUrban_model1_gls.RData"))

# Extract summary
birds_AllUrban_model1_gls_summary <- summary(birds_AllUrban_model1_gls)

# Extract correlation structure parameters
print(birds_AllUrban_model1_gls$modelStruct$corStruct)

# Get range parameter
birds_range_param <- coef(birds_AllUrban_model1_gls$modelStruct$corStruct, unconstrained = FALSE)
```

```{r gls birds log}
#| label: fig-birds-gls-logged-values
#| echo: false
#| message: false
#| fig-width: 12
#| fig-height: 8
#| fig-cap: "Diagnostic plots for Bird GLS"

# Extract residuals
birds_residuals_gls <- residuals(birds_AllUrban_model1_gls, type = "normalized")

# Get the data actually used in the model
birds_model_data <- getData(birds_AllUrban_model1_gls)

# Basic residual plots
par(mfrow = c(2, 2))

# Residuals vs fitted
plot(fitted(birds_AllUrban_model1_gls), birds_residuals_gls,
     xlab = "Fitted Values", ylab = "Normalized Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)

# QQ plot
qqnorm(birds_residuals_gls, main = "Normal Q-Q Plot")
qqline(birds_residuals_gls, col = "red")

# Residuals vs predictors
plot(birds_model_data$all_to_urban, birds_residuals_gls,
     xlab = "All to Urban", ylab = "Normalized Residuals",
     main = "Residuals vs All to Urban")
abline(h = 0, col = "red", lty = 2)

plot(birds_model_data$log_recorder_effort, birds_residuals_gls,
     xlab = "Recorder Effort", ylab = "Normalized Residuals",
     main = "Residuals vs Recorder Effort")
abline(h = 0, col = "red", lty = 2)
```

The diagnostic plots for this model show that:

1.  Residuals vs Fitted:
    -   There is some funneling, with variance spreading out at both ends
    -   This plots suggests residuals are suffering from a bit of heteroscedasticity
2.  QQ Plot:
    -   There is deviation from the line at both ends
    -   Our sample size is relatively large, and this is somewhat common with ecological data
3.  Residuals vs. Forest -\> TWS
    -   Data concentration at 0, which makes sense given that most of the cells will have no TWS to Forest
    -   There is a bit of fanning
4.  Residuals vs. Recorder Effort
    -   Residuals are evenly spread across the range of log recorder effort
    -   Residuals are (mostly) centered around zero and there is no obvious pattern observed

This model looks borderline acceptable to use. I could probably justify using it by wanting to keep the consistency.

### Trail 2: GLS with interaction

```{r gls birds interaction}
#| label: fig-birds-gls-logged-values-interaction
#| echo: false
#| message: false
#| fig-width: 12
#| fig-height: 8
#| fig-cap: "Diagnostic plots for Bird GLS with interaction"

# Load model
load(here("data", "models", "exploratory", "birds_AllUrban_model2_gls_interaction.RData"))

# Extract residuals
bird_residuals_gls <- residuals(birds_AllUrban_model2_gls_interaction, type = "normalized")

# Get the data actually used in the model
plants_model_data <- getData(birds_AllUrban_model2_gls_interaction)

# Basic residual plots
par(mfrow = c(2, 2))

# Residuals vs fitted
plot(fitted(birds_AllUrban_model2_gls_interaction), plant_residuals_gls,
     xlab = "Fitted Values", ylab = "Normalized Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red", lty = 2)

# QQ plot
qqnorm(plant_residuals_gls, main = "Normal Q-Q Plot")
qqline(plant_residuals_gls, col = "red")

# Residuals vs predictors
plot(plants_model_data$all_to_urban, plant_residuals_gls,
     xlab = "All to Urban", ylab = "Normalized Residuals",
     main = "Residuals vs Forest to TWS")
abline(h = 0, col = "red", lty = 2)

plot(plants_model_data$log_recorder_effort, plant_residuals_gls,
     xlab = "Recorder Effort", ylab = "Normalized Residuals",
     main = "Residuals vs Recorder Effort")
abline(h = 0, col = "red", lty = 2)
```
